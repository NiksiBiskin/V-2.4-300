[include ebb36_config.cfg]
[include stepper.cfg]
[include tmc.cfg]
[include autotune.cfg]
[include K-ShakeTune/*.cfg]
[include homing.cfg]
[include better_print_start.cfg]
[include KAMP_Settings.cfg]
[include fan.cfg]
[include _KOMB_Variables.cfg]
#[include _AFC_RENAMED_UNLOAD_FILAMENT_.cfg]
[include mainsail.cfg]
[include Backlash.cfg]

[mcu]
#serial: /dev/serial/by-id/usb-Klipper_stm32f446xx_470035001951303439363932-if00
serial: /dev/ttyAMA0
restart_method: command

[force_move]
enable_force_move: True

[idle_timeout]
timeout: 7200

[mcu rpi]
serial: /tmp/klipper_host_mcu

[exclude_object]
[respond]

[printer]
kinematics: corexy
max_velocity: 500
max_accel: 15000
max_z_velocity: 15
max_z_accel: 350
minimum_cruise_ratio: 0.5
square_corner_velocity: 5.0

[heater_bed]
heater_pin: PB4
sensor_type: Generic 3950
sensor_pin: PC2
max_power: 1.0
min_temp: 10
max_temp: 130
#control: mpc
heater_power: 600
cooling_fan: fan_generic bed_fans

[extruder]
#control: mpc
heater_power: 64
cooling_fan: fan
filament_density: 1.20
filament_heat_capacity: 1.8

[gcode_macro M109] # Wait Hotend Temp
rename_existing: M109.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  # Set hotend temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+5}   # Wait for hotend temp (within n degrees)
    {% endif %}


[gcode_macro M190] # Wait Bed Temp
rename_existing: M190.1
gcode:
    #Parameters
    {% set s = params.S|float %}

    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   # Set bed temp
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+5}  # Wait for bed temp (within n degrees)
    {% endif %}

[gcode_macro _SET_MPC_MATERIAL]
description: Set heater MPC parameters for a given material
variable_filament_table:
    ## Update this table to adjust material settings
    {
        ## ( density, heat capacity )  # suggested heat capacity range
        "PLA"       : ( 1.25, 2.20 ),  # 1.80 - 2.20
        "PETG"      : ( 1.27, 2.20 ),  # 1.70 - 2.20
        "PC+ABS"    : ( 1.15, 2.20 ),  # 1.50 - 2.20
        "ABS"       : ( 1.06, 2.40 ),  # 1.25 - 2.40
        "ASA"       : ( 1.07, 2.10 ),  # 1.30 - 2.10
        "PA6"       : ( 1.12, 2.50 ),  # 2.00 - 2.50
        "PA"        : ( 1.15, 2.50 ),  # 2.00 - 2.50
        "PC"        : ( 1.20, 1.90 ),  # 1.10 - 1.90
        "TPU"       : ( 1.21, 2.00 ),  # 1.50 - 2.00
        "TPU-90A"   : ( 1.15, 2.00 ),  # 1.50 - 2.00
        "TPU-95A"   : ( 1.22, 2.00 ),  # 1.50 - 2.00
        "ABS-CF"    : ( 1.11, 2.40 ),  # 1.25 - 2.40
        "ABS-GF"    : ( 1.11, 2.40 ),  # 1.25 - 2.40
        "ASA-CF"    : ( 1.11, 2.10 ),  # 1.30 - 2.10
        "PA6-CF"    : ( 1.19, 2.50 ),  # 2.00 - 2.50
        "PC+ABS-CF" : ( 1.22, 2.20 ),  # 1.50 - 2.20
        "PC-PBT-GF" : ( 1.22, 2.20 ),  # 1.50 - 2.20
        "PC+CF"     : ( 1.36, 1.90 ),  # 1.10 - 1.90
        "PLA-CF"    : ( 1.29, 2.20 ),  # 1.80 - 2.20
        "PETG-CF"   : ( 1.30, 2.20 ),  # 1.70 - 2.20
    }
gcode:
    {% set material = params.MATERIAL | upper %}
    {% set heater = params.HEATER | default('extruder') %}
    {% set extruder_config = printer.configfile.settings[heater] %}

    {% if material in filament_table %}
        {% set (density, heat_capacity) = filament_table[material] %}

        RESPOND PREFIX=ðŸ”¥ MSG="Configured {heater} MPC for {material}. Density: {density}, Heat Capacity: {heat_capacity}"
    {% else %}
        {% set density = extruder_config.filament_density %}
        {% set heat_capacity=extruder_config.filament_heat_capacity %}

        RESPOND PREFIX=ðŸ”¥ MSG="Unknown material '{material}', using default mpc parameters for {heater}"
    {% endif %}

    MPC_SET HEATER={heater} FILAMENT_DENSITY={density} FILAMENT_HEAT_CAPACITY={heat_capacity}

[firmware_retraction]
retract_length: 0.75 ; length of filament (in mm) at G10/G11
unretract_extra_length: 0 ; length of additional filament (in mm) at G11
retract_speed: 30    #50
unretract_speed: 25  #30

[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor Spider]
sensor_type: temperature_mcu
sensor_mcu: mcu
min_temp: 10
max_temp: 80

[mcu cartographer]
canbus_uuid: f8813c69bc20
#canbus_uuid: 08e5596c7aa0
canbus_interface: can0

[cartographer scan]
mesh_runs: 2


[cartographer]
mcu: cartographer

#   Offsets are measured from the centre of your coil, to the tip of your nozzle 
#   on a level axis. It is vital that this is accurate. 
x_offset: 0                          
#    adjust for your cartographers offset from nozzle to middle of coil
y_offset: 21.953                         
#    adjust for your cartographers offset from nozzle to middle of coil
#CARTOGRAPHER_ESTIMATE_BACKLASH=0.01776
#   Backlash compensation distance for removing Z backlash before measuring
#   the sensor response.
#sensor: cartographer
#    this must be set as cartographer unless using IDM etc.
#sensor_alt: carto
#    alternate name to call commands. CARTO_TOUCH etc      
#mesh_runs: 2
#    Number of passes to make during mesh scan.
verbose: yes # For extra output

[adxl345]
cs_pin: cartographer:PA3
spi_bus: spi1

[resonance_tester]
accel_chip: adxl345
probe_points:
    150, 150, 20
accel_per_hz: 100
sweeping_accel: 400
sweeping_period: 0

[temperature_sensor Cartographer]
sensor_type: temperature_mcu
sensor_mcu: cartographer
min_temp: 0
max_temp: 105

#[temperature_sensor cartographer_coil]
#sensor_type: cartographer_coil
#min_temp: 5
#max_temp: 140


#####################################################################
#  Bed Mesh Definition
#####################################################################
[bed_mesh]
speed: 300
horizontal_move_z: 3
mesh_min: 20,30
mesh_max: 270,245
#probe_count: 15,15
probe_count: 20,20
mesh_pps: 0,0   #2, 3
algorithm:bicubic
adaptive_margin: 10   # neu dazu
bicubic_tension: 0.1
fade_start: 0.1
fade_end: 10
fade_target: 0
zero_reference_position: 150,150

#####################################################################
#  Gantry Adjustment Routines
#####################################################################
[quad_gantry_level]
##  Min & Max gantry corners - measure from nozzle to respective belt positions
gantry_corners:
	-60,-10
	360,370
points:
   10,10
   10,245
   270,245
   270,10
speed: 300
horizontal_move_z: 5 #5 ; MagProbe 20, Vinda or Omron 5
retries: 20
retry_tolerance: 0.0075
max_adjust: 20

[shaketune]
result_folder: ~/printer_data/config/ShakeTune_results
#    The folder where the results will be stored. It will be created if it doesn't exist.
number_of_results_to_keep: 10
#    The number of results to keep in the result_folder. The oldest results will
#    be automatically deleted after each runs.
#keep_raw_csv: True
#    If True, the raw CSV files will be kept in the result_folder alongside the
#    PNG graphs. If False, they will be deleted and only the graphs will be kept.
show_macros_in_webui: True
#    Mainsail and Fluidd doesn't create buttons for "system" macros that are not in the
#    printer.cfg file. If you want to see the macros in the webui, set this to True.
timeout: 300
#    The maximum time in seconds to let Shake&Tune process the CSV files and generate the graphs.

[input_shaper]
##  A frequency (in Hz) of the input shaper for X or Y axis. 
shaper_freq_x: 65.2
shaper_freq_y: 45.6
##  A type of the intput shaper for X or Y axia.
shaper_type_x: mzv
shaper_type_y: mzv
##  Damping ratios of vibrations of X and Y axes used by input shapers
##  to improve vibration suppression. Default value is 0.1 which is a
##  good all-round value for most printers. In most circumstances this
##  parameter requires no tuning and should not be changed.
damping_ratio_x: 0.054
damping_ratio_y: 0.093

[gcode_macro SET_ACTIVE_SPOOL]
gcode:
  {% if params.ID %}
    {% set id = params.ID|int %}
    {action_call_remote_method(
       "spoolman_set_active_spool",
       spool_id=id
    )}
  {% else %}
    {action_respond_info("Parameter 'ID' is required")}
  {% endif %}

[gcode_macro CLEAR_ACTIVE_SPOOL]
gcode:
  {action_call_remote_method(
    "spoolman_set_active_spool",
    spool_id=None
  )}


[include AFC/*.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = mpc
#*# block_heat_capacity = 11.7607
#*# sensor_responsiveness = 0.0986554
#*# ambient_transfer = 0.103846
#*# fan_ambient_transfer = 0.103846, 0.107107, 0.112086, 0.113878, 0.119992, 0.117677, 0.113615, 0.12425, 0.122694, 0.118748, 0.118872
#*#
#*# [heater_bed]
#*# pid_version = 1
#*# pid_target = 110.00
#*# pid_tolerance = 0.0200
#*# pid_kp = 64.593
#*# pid_ki = 3.113
#*# pid_kd = 335.078
#*# control = mpc
#*# block_heat_capacity = 661.947
#*# sensor_responsiveness = 0.0188743
#*# ambient_transfer = 3.29782
#*# fan_ambient_transfer = 3.29782, 3.54129, 3.64761, 3.74756, 3.80902
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.066386, 0.066386, 0.062466, 0.058542, 0.056882, 0.060503, 0.060503, 0.056576, 0.048692, 0.041394, 0.041240, 0.041240, 0.043221, 0.052791, 0.057559, 0.060503, 0.058542, 0.054914, 0.060503, 0.067362
#*# 	0.066386, 0.064426, 0.062620, 0.058542, 0.056576, 0.060812, 0.060503, 0.056576, 0.048999, 0.043067, 0.041394, 0.043067, 0.045046, 0.051805, 0.057712, 0.058542, 0.055745, 0.054914, 0.062466, 0.062466
#*# 	0.066233, 0.060503, 0.056576, 0.054608, 0.052944, 0.056882, 0.056576, 0.051805, 0.042231, 0.037428, 0.033453, 0.033453, 0.037428, 0.041394, 0.047024, 0.050666, 0.045046, 0.041394, 0.047024, 0.048999
#*# 	0.066386, 0.060812, 0.058848, 0.052638, 0.056882, 0.058542, 0.058695, 0.053776, 0.044057, 0.037273, 0.037428, 0.035442, 0.039104, 0.045046, 0.050972, 0.048999, 0.047024, 0.041394, 0.048999, 0.054608
#*# 	0.060503, 0.056729, 0.052944, 0.048999, 0.048999, 0.052944, 0.048999, 0.045046, 0.035442, 0.027482, 0.029472, 0.027482, 0.025640, 0.031464, 0.037428, 0.037428, 0.034295, 0.031464, 0.033453, 0.039411
#*# 	0.054914, 0.048845, 0.045046, 0.045046, 0.045046, 0.048999, 0.047024, 0.033453, 0.023489, 0.021797, 0.021797, 0.021643, 0.019796, 0.021797, 0.027482, 0.030622, 0.025793, 0.023796, 0.029472, 0.034295
#*# 	0.048999, 0.045046, 0.043067, 0.041086, 0.039412, 0.041086, 0.037428, 0.027482, 0.017797, 0.013786, 0.014943, 0.011777, 0.009767, 0.009767, 0.013786, 0.021490, 0.017797, 0.017797, 0.019489, 0.025487
#*# 	0.047024, 0.045046, 0.041394, 0.041086, 0.041240, 0.037273, 0.031464, 0.025793, 0.015792, 0.013786, 0.013786, 0.012085, 0.007759, 0.011777, 0.013786, 0.015792, 0.017797, 0.013940, 0.017797, 0.023489
#*# 	0.044211, 0.043067, 0.039412, 0.037428, 0.034448, 0.032613, 0.024641, 0.018643, 0.012085, 0.005744, 0.007759, 0.004038, 0.002020, 0.005744, 0.006053, 0.010075, 0.009767, 0.005744, 0.006906, 0.009767
#*# 	0.045046, 0.041394, 0.037428, 0.035442, 0.029472, 0.027482, 0.021490, 0.013786, 0.006053, 0.002874, 0.002020, 0.000000, 0.002020, 0.004038, 0.007759, 0.007759, 0.005744, 0.004038, 0.006053, 0.006906
#*# 	0.047024, 0.042077, 0.037428, 0.035442, 0.031773, 0.027482, 0.021797, 0.013786, 0.003728, 0.000000, 0.000000, -0.002022, -0.000856, 0.002020, 0.003029, 0.003728, 0.001010, 0.000000, -0.002022, 0.000000
#*# 	0.047024, 0.043067, 0.039104, 0.035289, 0.034448, 0.031464, 0.025487, 0.015792, 0.004038, 0.000000, 0.000000, 0.000000, 0.000000, 0.004038, 0.008063, 0.006906, 0.004038, 0.001010, 0.002020, 0.002020
#*# 	0.048845, 0.043067, 0.039412, 0.041086, 0.037428, 0.035442, 0.029472, 0.017797, 0.007911, 0.002020, -0.002878, -0.002022, 0.000000, 0.002020, 0.004038, 0.004038, 0.002020, -0.002022, -0.003735, -0.004041
#*# 	0.048999, 0.045046, 0.043067, 0.042077, 0.039258, 0.037273, 0.031464, 0.023489, 0.013786, 0.007759, 0.000310, 0.002020, 0.004038, 0.006053, 0.005744, 0.006053, 0.006053, -0.002022, 0.000000, 0.000000
#*# 	0.052944, 0.052944, 0.050972, 0.048999, 0.048845, 0.047024, 0.039104, 0.033453, 0.023796, 0.017797, 0.013786, 0.012085, 0.013786, 0.015792, 0.013786, 0.011777, 0.008763, 0.005899, 0.004038, 0.004038
#*# 	0.060503, 0.058542, 0.058542, 0.056882, 0.056576, 0.054914, 0.048999, 0.043067, 0.037428, 0.029627, 0.027482, 0.027482, 0.025487, 0.027788, 0.029472, 0.025487, 0.021797, 0.019796, 0.021797, 0.019796
#*# 	0.068343, 0.066386, 0.062466, 0.062466, 0.060812, 0.060503, 0.058542, 0.050972, 0.045046, 0.040095, 0.035442, 0.034295, 0.034448, 0.033453, 0.035442, 0.035442, 0.029781, 0.027482, 0.027788, 0.027482
#*# 	0.070298, 0.070298, 0.066386, 0.068343, 0.068343, 0.066386, 0.062466, 0.058848, 0.050972, 0.047024, 0.045046, 0.043067, 0.041086, 0.041086, 0.041086, 0.041086, 0.039258, 0.035442, 0.036435, 0.039412
#*# 	0.071123, 0.072252, 0.070298, 0.072100, 0.072252, 0.072100, 0.066386, 0.062466, 0.058848, 0.052944, 0.048999, 0.047024, 0.041394, 0.045046, 0.045046, 0.043067, 0.043067, 0.043067, 0.043375, 0.043067
#*# 	0.072252, 0.071948, 0.071948, 0.074204, 0.075851, 0.074204, 0.070146, 0.064426, 0.060503, 0.058542, 0.050972, 0.050972, 0.048999, 0.048999, 0.050972, 0.048692, 0.045046, 0.047024, 0.052638, 0.050972
#*# x_count = 20
#*# y_count = 20
#*# mesh_x_pps = 0
#*# mesh_y_pps = 0
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 270.0
#*# min_y = 30.0
#*# max_y = 245.0
#*#
#*# [cartographer scan_model default]
#*# coefficients = 1.2633266290761636,1.7342554077612862,0.8104304022496828,0.2233768615350482,0.6372253234935904,1.3506291476538634,-0.5658813957559605,-1.5725608340859085,0.6538498778998851,0.9649465237530991
#*# domain = 2.97907298752933e-07,3.2952448433897455e-07
#*# z_offset = 0
#*#
#*# [cartographer touch_model default]
#*# threshold = 3729
#*# speed = 2
#*# z_offset = -0.05
#*#
#*# [cartographer]
#*# z_backlash = 0.01354
